#!/bin/sh

# Цветной вывод
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Функции для вывода
print_msg() {
    echo -e "${GREEN}[*] $1${NC}"
}

print_error() {
    echo -e "${RED}[!] Ошибка: $1${NC}"
    exit 1
}

print_step() {
    echo -e "${YELLOW}=== $1 ===${NC}"
}

# Обновление пакетов
print_step "Обновление списка пакетов"
opkg update || print_error "Не удалось обновить список пакетов"

# Установка kmod-nft-tproxy
print_step "Установка kmod-nft-tproxy"
opkg install kmod-nft-tproxy || print_error "Не удалось установить kmod-nft-tproxy"

# Установка luci-app-clash
print_step "Установка luci-app-clash"
print_msg "Скачивание luci-app-clash..."
wget -O /tmp/luci-app-clash.ipk https://raw.githubusercontent.com/bobaboba76/lash/main/luci-app-clash.ipk || print_error "Не удалось скачать luci-app-clash"
print_msg "Установка luci-app-clash..."
opkg install /tmp/luci-app-clash.ipk || print_error "Ошибка при установке luci-app-clash"
rm -f /tmp/luci-app-clash.ipk
print_msg "luci-app-clash установлен"

# Установка subconverter
print_step "Установка subconverter v0.9.0"
print_msg "Скачивание subconverter..."
wget -O /tmp/subconverter.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.9.0/subconverter_aarch64.tar.gz || print_error "Не удалось скачать subconverter"
print_msg "Распаковка subconverter..."
mkdir -p /opt/subconverter
tar -xzf /tmp/subconverter.tar.gz -C /opt/subconverter || print_error "Ошибка распаковки subconverter"
chmod +x /opt/subconverter/subconverter || print_error "Ошибка chmod для subconverter"

print_msg "Создание init-скрипта для subconverter..."
cat > /etc/init.d/subconverter << 'EOF'
#!/bin/sh /etc/rc.common

START=99
STOP=10

start() {
    echo "Запуск subconverter..."
    /opt/subconverter/subconverter >/dev/null 2>&1 &
}

stop() {
    echo "Остановка subconverter..."
    killall subconverter 2>/dev/null
}
EOF

chmod +x /etc/init.d/subconverter
/etc/init.d/subconverter enable
/etc/init.d/subconverter start
sleep 2

if netstat -tuln | grep -q ":25500"; then
    print_msg "subconverter успешно запущен на 127.0.0.1:25500"
else
    print_error "subconverter не запустился"
fi
rm -f /tmp/subconverter.tar.gz

# Установка Clash (в самом конце)
print_step "Установка Clash"
print_msg "Остановка Clash (если он запущен)..."
/etc/init.d/clash stop 2>/dev/null

print_msg "Создание директории /opt/clash/bin..."
mkdir -p /opt/clash/bin || print_error "Не удалось создать директорию"

print_msg "Скачивание Clash..."
wget -O /opt/clash/bin/clash.gz https://raw.githubusercontent.com/bobaboba76/lash/main/clash.gz || print_error "Ошибка скачивания Clash"

print_msg "Распаковка Clash..."
gunzip -f /opt/clash/bin/clash.gz || print_error "Ошибка распаковки clash.gz"
chmod +x /opt/clash/bin/clash || print_error "Ошибка chmod для clash"
print_msg "Clash установлен в /opt/clash/bin"

# Перезагрузка
print_step "Перезагрузка устройства"
print_msg "Установка завершена. Перезагружаем..."
sleep 2
reboot
