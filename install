#!/bin/sh

# Functions for printing messages
print_msg() {
    echo "[*] $1"
}

print_error() {
    echo "[!] Error: $1"
    exit 1
}

print_step() {
    echo "=== $1 ==="
}

# Update packages only from official sources
print_step "Updating package list"
opkg update || print_error "Failed to update package list"

# Install kmod-nft-tproxy
print_step "Installing kmod-nft-tproxy"
opkg install kmod-nft-tproxy || print_error "Failed to install kmod-nft-tproxy"

# Install luci-app-clash
print_step "Installing luci-app-clash"
print_msg "Downloading luci-app-clash..."
wget -O /tmp/luci-app-clash.ipk https://raw.githubusercontent.com/bobaboba76/lash/main/luci-app-clash.ipk || print_error "Failed to download luci-app-clash.ipk"
print_msg "Installing luci-app-clash..."
opkg install /tmp/luci-app-clash.ipk || print_error "Failed to install luci-app-clash"
rm -f /tmp/luci-app-clash.ipk
print_msg "luci-app-clash installed"

# Install Clash (at the very end)
print_step "Installing Clash"
print_msg "Stopping Clash before installation..."
/etc/init.d/clash stop 2>/dev/null || print_msg "Clash was not running"
print_msg "Creating directory /opt/clash/bin..."
mkdir -p /opt/clash/bin || print_error "Failed to create directory /opt/clash/bin"
print_msg "Downloading Clash..."
wget -O /opt/clash/bin/clash.gz https://raw.githubusercontent.com/bobaboba76/lash/main/clash.gz || print_error "Failed to download clash.gz"
print_msg "Extracting Clash..."
gunzip /opt/clash/bin/clash.gz || print_error "Failed to extract clash.gz"
chmod +x /opt/clash/bin/clash
print_msg "Clash installed in /opt/clash/bin"

# Reboot
print_step "Rebooting device"
print_msg "All components installed. Rebooting..."
sleep 2
reboot
